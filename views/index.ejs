<!DOCTYPE html>
<html>

<head>
  <meta charset='UTF-8' />
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="/stylesheets/weui.css" />
  <link rel="stylesheet" href="/stylesheets/example.css">
</head>

<body ontouchstart>
  <input id="userId" value="<%= user.userId%>" hidden disabled/>
  <div class="page" style="opacity: 1">
    <div class="page__bd">
      <h1 style="margin: 10px;"><%= user.username%></h1>
    </div>
    <div class="page__bd">
      <div class="button_sp_area">
        <a href="task?userId=<%=user.userId%>&username=<%=user.username%>" class="weui-btn weui-btn_primary" style="margin: 20px 10px;">新建任务</a>
      </div>
      <div class="weui-panel weui-panel_access">
        <div class="weui-panel__hd">我的任务列表</div>
        <div id="task-list" class="weui-panel__bd">
          <% if(taskList.length > 0) { %>
            <% for(var i = 0; i < taskList.length; i++) { %>
            <a href="task/<%= taskList[i].id %>" class="weui-media-box weui-media-box_appmsg">
              <div class="weui-media-box__hd">
                <img class="weui-media-box__thumb" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAB4CAMAAAAOusbgAAAAeFBMVEUAwAD///+U5ZTc9twOww7G8MYwzDCH4YcfyR9x23Hw+/DY9dhm2WZG0kbT9NP0/PTL8sux7LFe115T1VM+zz7i+OIXxhes6qxr2mvA8MCe6J6M4oz6/frr+us5zjn2/fa67rqB4IF13XWn6ad83nxa1loqyirn+eccHxx4AAAC/klEQVRo3u2W2ZKiQBBF8wpCNSCyLwri7v//4bRIFVXoTBBB+DAReV5sG6lTXDITiGEYhmEYhmEYhmEYhmEY5v9i5fsZGRx9PyGDne8f6K9cfd+mKXe1yNG/0CcqYE86AkBMBh66f20deBc7wA/1WFiTwvSEpBMA2JJOBsSLxe/4QEEaJRrASP8EVF8Q74GbmevKg0saa0B8QbwBdjRyADYxIhqxAZ++IKYtciPXLQVG+imw+oo4Bu56rjEJ4GYsvPmKOAB+xlz7L5aevqUXuePWVhvWJ4eWiwUQ67mK51qPj4dFDMlRLBZTqF3SDvmr4BwtkECu5gHWPkmDfQh02WLxXuvbvC8ku8F57GsI5e0CmUwLz1kq3kD17R1In5816rGvQ5VMk5FEtIiWislTffuDpl/k/PzscdQsv8r9qWq4LRWX6tQYtTxvI3XyrwdyQxChXioOngH3dLgOFjk0all56XRi/wDFQrGQU3Os5t0wJu1GNtNKHdPqYaGYQuRDfbfDf26AGLYSyGS3ZAK4S8XuoAlxGSdYMKwqZKM9XJMtyqXi7HX/CiAZS6d8bSVUz5J36mEMFDTlAFQzxOT1dzLRljjB6+++ejFqka+mXIe6F59mw22OuOw1F4T6lg/9VjL1rLDoI9Xzl1MSYDNHnPQnt3D1EE7PrXjye/3pVpr1Z45hMUdcACc5NVQI0bOdS1WA0wuz73e7/5TNqBPhQXPEFGJNV2zNqWI7QKBd2Gn6AiBko02zuAOXeWIXjV0jNqdKegaE/kJQ6Bfs4aju04lMLkA2T5wBSYPKDGF3RKhFYEa6A1L1LG2yacmsaZ6YPOSAMKNsO+N5dNTfkc5Aqe26uxHpx7ZirvgCwJpWq/lmX1hA7LyabQ34tt5RiJKXSwQ+0KU0V5xg+hZrd4Bn1n4EID+WkQdgLfRNtvil9SPfwy+WQ7PFBWQz6dGWZBLkeJFXZGCfLUjCgGgqXo5TuSu3cugdcTv/HjqnBTEMwzAMwzAMwzAMwzAMw/zf/AFbXiOA6frlMAAAAABJRU5ErkJggg=="
                  alt="">
              </div>
              <div class="weui-media-box__bd">
                <h4 class="weui-media-box__title">
                  <%= taskList[i].createTimeString %>
                </h4>
                <p class="weui-media-box__desc">
                  <%= taskList[i].description %>
                </p>
              </div>
            </a>
            <% } %>
          <% } else { %>
            <div class="weui-cells__tips">您当前无任务</div>
          <% } %>
        </div>
        <div class="page__bd">
          <div class="button_sp_area">
            <a href="#" id="btn-load_more" class="weui-btn weui-btn_plain_default" style="font-size: 14px; color: grey; margin: 0 15px;">加载更多</a>
            <div id="hint-loading" class="weui-loadmore">
              <i class="weui-loading"></i>
              <span id="hint-loading" class="weui-loadmore__tips">正在加载</span>
            </div>
          </div>
          <div class="weui-loadmore weui-loadmore_line weui-loadmore_dot">
            <span class="weui-loadmore__tips"></span>
          </div>
          <div id="hint-no_more" class="weui-loadmore weui-loadmore_line">
            <span id="hint-no_more" class="weui-loadmore__tips">暂无更多数据</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/bower_components/zepto/zepto.min.js"></script>
  <script src="http://rawgit.com/progrape/weui.js/master/dist/weui.js"></script>
  <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
  <script src="/javascripts/wechat/weixin.js"></script>

  <script>
    
    $(function() {
      $("#hint-no_more").hide();
      $("#hint-loading").hide();

      var lastTaskCreateTime = <%=taskList.length > 0 ? taskList[taskList.length-1].createTime : 0 %>;

      $("#btn-load_more").on('click', function() {
        $("#btn-load_more").hide();
        $("#hint-loading").show();
        $.get('/loadmore?userId=<%=user.userId%>&startTime=' + lastTaskCreateTime, function(res) {
          $("#hint-loading").hide();
          $("#btn-load_more").show();
          if (res.size > 0) {
            $("#task-list").append(res.html);
            lastTaskCreateTime = res.leastTime;
          } else {
            $("#hint-no_more").show();
            $("#btn-load_more").remove();
          }
        });
      });
    });
  </script>
</body>

</html>
